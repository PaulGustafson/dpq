module Gates where

import "lib/Basics.dpq"
import "lib/Nat.dpq"


-- All gates must have at least one input.

gate {1,0,1} Init0 : Unit -> Qubit

gate {1,0,1} Init1 : Unit -> Qubit

gate {1,0,1} Term0 : Qubit -> Unit
gate {1,0,1} Term1 : Qubit -> Unit

gate {1,1,1} WGate : Qubit -> Qubit -> Qubit * Qubit

gate {1,1,1} WGateInverse : Qubit -> Qubit -> Qubit * Qubit

gate {1,1,1} H : Qubit -> Qubit

gate {1,1,1} TGate : Qubit -> Qubit

gate {1,1,1} C_H : Qubit -> Qubit -> Qubit * Qubit


-- The second qubit is the control bit
gate {1,1,1} CNot : Qubit -> Qubit -> Qubit * Qubit

-- convention: to support circuit printing,
-- any nontrivial binary control gate have to be prefixed with `C_`, e->g->
-- the following C_X, C_Z->
gate {1,0,1} C_X : Qubit -> Bit -> Qubit * Bit

gate {1,0,1} C_Z : Qubit -> Bit -> Qubit * Bit

-- Rotatation gate, its parameter must be a monomoprhic type
gate {1,1,1} R Nat : Qubit -> Qubit -> Qubit * Qubit

gate {1,0,0} Discard : Bit -> Unit

-- Measurement gate
gate {1,0,0} Mea : Qubit -> Bit



-- A Toffoli gate specialized to one positive and one negative
-- control-> The second argument is the positive control and the third
-- argument is the negative one->
gate {1,1,1} ToffoliGate_10 : Qubit -> Qubit -> Qubit -> Qubit * Qubit * Qubit

-- A Toffoli gate specialized to one positive and one negative
-- control-> The second argument is the negative control and the third
-- argument is the positive one->
gate {1,1,1} ToffoliGate_01 : Qubit -> Qubit -> Qubit -> Qubit * Qubit * Qubit

-- A Toffoli gate with signed controls-> A sign of 'True' means the
-- control fires when the qubit is 1; a sign of 'False' means the
-- control fires when the qubit is 0->
-- The first parameter controls the second qubit, the second parameter
-- controls the third qubit
gate {1,1,1} ToffoliGate Bool Bool : Qubit -> Qubit -> Qubit -> Qubit * Qubit * Qubit


-- A controlled-not gate with a signed control, the second qubit is the controlling qubit
gate {1,1,1} CNotGate Bool : Qubit -> Qubit -> Qubit * Qubit

-- A not gate
gate {1,1,1} QNot : Qubit -> Qubit


gate {1,1,1} ControlledExpGate Bool : Qubit -> Qubit -> Qubit * Qubit

-- A wrapper on ControlledExpGate
controlledExpGate : ! (Qubit -> Qubit * Bool -> Qubit * Qubit)
controlledExpGate q t =
  let (y, sign) = t
  in ControlledExpGate sign q y

qterm : ! (Bool -> Qubit -> Unit)
qterm b q =
  case b of
   True -> Term1 q
   False -> Term0 q

qterm' : ! (Bool * Qubit -> Unit)
qterm' bq =
 let (b, q) = bq in qterm b q
 


-- Generalized multi-control gate
-- controlled Not_g : Qubit -> Qubit
-- controlled H_g : Qubit -> Qubit
not_g : ! forall s -> (Simple s) => Qubit -> s -> Qubit * s
not_g q s = controlled (box Qubit QNot) q s

h_g : ! forall s -> (Simple s) => Qubit -> s -> Qubit * s
h_g q s = controlled (box Qubit H) q s

cnot : ! forall u -> (Simple u) => Qubit -> Qubit -> u -> (Qubit * Qubit) * u
cnot a b s =
   let (a, bs) = not_g
                  a
		  (b, s)
       (b, s) = bs
   in ((a, b), s)



initQubit : ! (Bool -> Qubit)
initQubit b = case b of
                True -> Init1 ()
		False -> Init0 ()



